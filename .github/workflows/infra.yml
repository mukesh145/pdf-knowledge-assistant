name: Deploy Infrastructure

on:
  # push: 
  #   branches: [ main ]
  #   paths:
  #     - 'infra/**'

  workflow_dispatch:

permissions:
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION}}
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID}}
  ECR_REPO: ${{vars.ECR_REPO}}
  ECS_CLUSTER: ${{vars.ECS_CLUSTER}}
  ECS_SERVICE: ${{vars.ECS_SERVICE}}
  IMAGE_TAG: ${{github.sha}}

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          aws-region: ${{env.AWS_REGION}}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Restore Terraform cache
        uses: actions/cache@v4
        id: terraform-cache
        with:
          path: |
            ~/.terraform.d/plugins
            infra/.terraform
          key: ${{ runner.os }}-terraform-${{ hashFiles('infra/**/*.tf') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init

      - name: Terraform Plan
        working-directory: ./infra
        run: terraform plan -out=tfplan -no-color
        continue-on-error: false

      - name: Save Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infra/tfplan
          retention-days: 7

      - name: Terraform Apply
        working-directory: ./infra
        run: terraform apply -auto-approve tfplan

      - name: Upload Terraform State
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-state
          path: |
            infra/*.tfstate
            infra/*.tfstate.backup
          retention-days: 30
