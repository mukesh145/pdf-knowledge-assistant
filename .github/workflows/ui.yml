name: Build, Push and Deploy UI (ECR->ECS)

on:
  # push: 
    # branches: [ main ]
    # paths:
    #   - 'frontend/**'
    #   - 'Dockerfile.frontend'
    #   - '.github/workflows/ui.yml'

  workflow_dispatch:

permissions:
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION}}
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID}}
  ECR_REPO: ${{ vars.ECR_REPO_UI }}
  ECS_CLUSTER: ${{vars.ECS_CLUSTER}}
  ECS_SERVICE: ${{ vars.ECS_SERVICE_UI}}
  IMAGE_TAG: ${{github.sha}}

jobs:
  build_and_push_ui:
    name: Build and Push UI Image to ECR
    runs-on: ubuntu-latest
    outputs:
      IMAGE_URI: ${{steps.compute.outputs.IMAGE_URI}}
      IMAGE_REF: ${{steps.compute.outputs.IMAGE_REF}}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          aws-region: ${{env.AWS_REGION}}
      
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/arm64,linux/amd64
      
      - name: Compute Image URI
        id: compute
        run: |
          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"
          IMAGE_REF="${IMAGE_URI}:${IMAGE_TAG}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "IMAGE_REF=${IMAGE_REF}" >> $GITHUB_OUTPUT
        
      - name: Build and Push UI Image 
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{steps.compute.outputs.IMAGE_REF}}
            ${{steps.compute.outputs.IMAGE_URI}}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
  
  deploy-ecs:
    name: Deploy UI to ECS (rolling updates)
    needs: build_and_push_ui
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          aws-region: ${{env.AWS_REGION}}
      
      - name: Get ALB DNS name
        id: get-alb
        run: |
          # Try to get ALB URL from GitHub variable first, otherwise query AWS
          if [ -n "${{ vars.ALB_URL }}" ]; then
            ALB_URL="${{ vars.ALB_URL }}"
            echo "Using ALB URL from GitHub variable: $ALB_URL"
          else
            # Get ALB DNS name by querying AWS (assuming ALB name follows pattern: {app-name}-alb)
            APP_NAME="${{ vars.APP_NAME != '' && vars.APP_NAME || 'pdf-knowledge-assistant' }}"
            echo "Looking for ALB with name containing: ${APP_NAME}"
            
            # List all ALBs and find one matching the app name
            ALB_DNS=$(aws elbv2 describe-load-balancers --region ${{env.AWS_REGION}} \
              --query "LoadBalancers[?contains(LoadBalancerName, '${APP_NAME}')].DNSName" \
              --output text | head -n 1 | xargs)
            
            if [ -z "$ALB_DNS" ] || [ "$ALB_DNS" = "None" ]; then
              echo "Warning: Could not find ALB matching '${APP_NAME}'. Listing all ALBs:"
              aws elbv2 describe-load-balancers --region ${{env.AWS_REGION}} \
                --query "LoadBalancers[*].[LoadBalancerName,DNSName]" --output table || true
              echo ""
              echo "ERROR: Please set ALB_URL as a GitHub variable or ensure ALB exists."
              echo "You can find the ALB DNS name in AWS Console or Terraform outputs."
              exit 1
            else
              ALB_URL="http://${ALB_DNS}"
              echo "Found ALB DNS: $ALB_DNS"
              echo "Using API Base URL: ${ALB_URL}"
            fi
          fi
          echo "API_BASE_URL=${ALB_URL}" >> $GITHUB_OUTPUT
      
      - name: Debug ALB URL output
        run: |
          echo "API_BASE_URL value: ${{ steps.get-alb.outputs.API_BASE_URL }}"
      
      - name: Render task defination with new image
        id: render
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with: 
          task-definition: deploy/task-def-ui.json
          container-name: ${{ vars.ECS_CONTAINER_NAME_UI != '' && vars.ECS_CONTAINER_NAME_UI || 'pdf-knowledge-assistant-ui' }}
          image: ${{needs.build_and_push_ui.outputs.IMAGE_REF}}
          container-env-vars: |
            VITE_API_BASE_URL=${{ steps.get-alb.outputs.API_BASE_URL }}
      
      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{steps.render.outputs.task-definition}}
          service: ${{env.ECS_SERVICE}}
          cluster: ${{env.ECS_CLUSTER}}
          wait-for-service-stability: true